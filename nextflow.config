/*
 * nextflow.config â€” aligned with:
 *   - Docker image: jcap/rnaseq-pipeline:latest
 *   - Singularity SIF: containers/rnaseq-pipeline.sif
 *   - sbatch script: sets PROFILE=singularity by default
 */

params {
  input_dir = 'data'
  outdir    = 'results'
  ref       = 'ref.fa'
  threads   = 4

  // For Singularity profile: path to a locally-built SIF
  // (Build from rnaseq-pipeline.def)
  sif       = 'containers/rnaseq-pipeline.sif'
}

process {
  executor       = 'local'
  cpus           = { params.threads }
  errorStrategy  = 'terminate'
  maxRetries     = 1
  shell          = ['/bin/bash', '-ue']
}

/* ----------------------------- PROFILES ----------------------------------- */
profiles {

  /*
   * Local execution without environment management.
   * Assumes tools exist in PATH on the host.
   */
  standard {
    // defaults only
  }

  /*
   * Conda profile for local use (reproducible installs).
   * Uses envs/rnaseq.yml for every process.
   */
  conda {
    conda.enabled = true

    process {
      conda = 'envs/rnaseq.yml'
    }
  }

  /*
   * Docker profile (recommended on a workstation).
   * Uses a single image that contains all tools.
   */
  docker {
    docker.enabled = true
    singularity.enabled = false

    process {
      container = 'jcap/rnaseq-pipeline:latest'
    }
  }

  /*
   * Singularity profile (recommended on HPC).
   *
   * Option A (default here): use a pre-built SIF file from the repo
   *   containers/rnaseq-pipeline.sif
   *
   * Option B: pull from Docker registry automatically
   *   container = 'docker://jcap/rnaseq-pipeline:latest'
   * (uncomment that line if you prefer it and your cluster allows pulls)
   */
  singularity {
    docker.enabled = false
    singularity.enabled = true
    singularity.autoMounts = true
    // singularity.cacheDir can be set via env var SINGULARITY_CACHEDIR (recommended)

    process {
      container = params.sif
      // container = "docker://jcap/rnaseq-pipeline:latest"  // Option B
    }
  }

  /*
   * SLURM profile (optional): if you want Nextflow to submit each task to SLURM
   * instead of running under a single sbatch wrapper.
   *
   * Use ONLY if your cluster expects this style.
   */
  slurm_singularity {
    process.executor = 'slurm'
    process.queue    = 'general'
    process.cpus     = { params.threads }
    process.memory   = '32 GB'
    process.time     = '2h'

    singularity.enabled = true
    singularity.autoMounts = true

    process.container = params.sif
  }
}
